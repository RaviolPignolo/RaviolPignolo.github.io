// Champions
import { Karthus } from './champions/Karthus.js';
import { Twitch } from './champions/Twitch.js';
// Items
import { AbyssalMask } from './items/AbyssalMask.js';
import { ArchangelsStaff } from './items/ArchangelsStaff.js';
import { ArdentCenser } from './items/ArdentCenser.js';
import { ArmoredAdvance } from './items/ArmoredAdvance.js';
import { AxiomArc } from './items/AxiomArc.js';
import { BansheesVeil } from './items/BansheesVeil.js';
import { BerserkersGreaves } from './items/BerserkersGreaves.js';
import { BlackCleaver } from './items/BlackCleaver.js';
import { BlackfireTorch } from './items/BlackfireTorch.js';
import { BladeOfTheRuinedKing } from './items/BladeOfTheRuinedKing.js';
import { BloodlettersCurse } from './items/BloodlettersCurse.js';
import { Bloodthirster } from './items/Bloodthirster.js';
import { Boots } from './items/Boots.js';
import { BootsOfSwiftness } from './items/BootsOfSwiftness.js';
import { ChempunkChainsword } from './items/ChempunkChainsword.js';
import { ChainlacedCrushers } from './items/ChainlacedCrushers.js';
import { CosmicDrive } from './items/CosmicDrive.js';
import { CrimsonLucidity } from './items/CrimsonLucidity.js';
import { Cryptbloom } from './items/Cryptbloom.js';
import { Dawncore } from './items/Dawncore.js';
import { DeadMansPlate } from './items/DeadMansPlate.js';
import { DeathsDance } from './items/DeathsDance.js';
import { EchoesOfHelia } from './items/EchoesOfHelia.js';
import { Eclipse } from './items/Eclipse.js';
import { EdgeOfNight } from './items/EdgeOfNight.js';
import { EssenceReaver } from './items/EssenceReaver.js';
import { ExperimentalHexplate } from './items/ExperimentalHexplate.js';
import { Fimbulwinter } from './items/Fimbulwinter.js';
import { ForceOfNature } from './items/ForceOfNature.js';
import { ForeverForward } from './items/ForeverForward.js';
import { FrozenHeart } from './items/FrozenHeart.js';
import { GuardianAngel } from './items/GuardianAngel.js';
import { GuinsoosRageblade } from './items/GuinsoosRageblade.js';
import { GunmetalGreaves } from './items/GunmetalGreaves.js';
import { Heartsteel } from './items/Heartsteel.js';
import { HextechRocketbelt } from './items/HextechRocketbelt.js';
import { HollowRadiance } from './items/HollowRadiance.js';
import { HorizonFocus } from './items/HorizonFocus.js';
import { Hubris } from './items/Hubris.js';
import { Hullbreaker } from './items/Hullbreaker.js';
import { IcebornGauntlet } from './items/IcebornGauntlet.js';
import { ImmortalShieldbow } from './items/ImmortalShieldbow.js';
import { ImperialMandate } from './items/ImperialMandate.js';
import { InfinityEdge } from './items/InfinityEdge.js';
import { IonianBootsOfLucidity } from './items/IonianBootsOfLucidity.js';
import { JakShoTheProtean } from './items/JakShoTheProtean.js';
import { KaenicRookern } from './items/KaenicRookern.js';
import { KnightsVow } from './items/KnightsVow.js';
import { KrakenSlayer } from './items/KrakenSlayer.js';
import { LiandrysTorment } from './items/LiandrysTorment.js';
import { LichBane } from './items/LichBane.js';
import { LocketOfTheIronSolari } from './items/LocketOfTheIronSolari.js';
import { LordDominiksRegards } from './items/LordDominiksRegards.js';
import { LudensCompanion } from './items/LudensCompanion.js';
import { Malignance } from './items/Malignance.js';
import { Manamune } from './items/Manamune.js';
import { MawOfMalmortius } from './items/MawOfMalmortius.js';
import { MejaisSoulstealer } from './items/MejaisSoulstealer.js';
import { MercurialScimitar } from './items/MercurialScimitar.js';
import { MercurysTreads } from './items/MercurysTreads.js';
import { MikaelsBlessing } from './items/MikaelsBlessing.js';
import { MoonstoneRenewer } from './items/MoonstoneRenewer.js';
import { Morellonomicon } from './items/Morellonomicon.js';
import { MortalReminder } from './items/MortalReminder.js';
import { Muramana } from './items/Muramana.js';
import { NashorsTooth } from './items/NashorsTooth.js';
import { NavoriFlickerblade } from './items/NavoriFlickerblade.js';
import { Opportunity } from './items/Opportunity.js';
import { OverlordsBloodmail } from './items/OverlordsBloodmail.js';
import { PhantomDancer } from './items/PhantomDancer.js';
import { PlatedSteelcaps } from './items/PlatedSteelcaps.js';
import { ProfaneHydra } from './items/ProfaneHydra.js';
import { RabadonsDeathcap } from './items/RabadonsDeathcap.js';
import { RanduinsOmen } from './items/RanduinsOmen.js';
import { RapidFirecannon } from './items/RapidFirecannon.js';
import { RavenousHydra } from './items/RavenousHydra.js';
import { Redemption } from './items/Redemption.js';
import { Riftmaker } from './items/Riftmaker.js';
import { RodOfAges } from './items/RodOfAges.js';
import { RunaansHurricane } from './items/RunaansHurricane.js';
import { RylaisCrystalScepter } from './items/RylaisCrystalScepter.js';
import { SeraphsEmbrace } from './items/SeraphsEmbrace.js';
import { SerpentsFang } from './items/SerpentsFang.js';
import { SeryldasGrudge } from './items/SeryldasGrudge.js';
import { Shadowflame } from './items/Shadowflame.js';
import { ShurelyasBattlesong } from './items/ShurelyasBattlesong.js';
import { SorcerersShoes } from './items/SorcerersShoes.js';
import { SpearOfShojin } from './items/SpearOfShojin.js';
import { SpellslingersShoes } from './items/SpellslingersShoes.js';
import { SpiritVisage } from './items/SpiritVisage.js';
import { StaffOfFlowingWater } from './items/StaffOfFlowingWater.js';
import { StatikkShiv } from './items/StatikkShiv.js';
import { SteraksGage } from './items/SteraksGage.js';
import { Stormsurge } from './items/Stormsurge.js';
import { Stridebreaker } from './items/Stridebreaker.js';
import { SunderedSky } from './items/SunderedSky.js';
import { SunfireAegis } from './items/SunfireAegis.js';
import { Swiftmarch } from './items/Swiftmarch.js';
import { SymbioticSoles } from './items/SymbioticSoles.js';
import { SynchronizedSouls } from './items/SynchronizedSouls.js';
import { Terminus } from './items/Terminus.js';
import { TheCollector } from './items/TheCollector.js';
import { Thornmail } from './items/Thornmail.js';
import { TitanicHydra } from './items/TitanicHydra.js';
import { Trailblazer } from './items/Trailblazer.js';
import { TrinityForce } from './items/TrinityForce.js';
import { UmbralGlaive } from './items/UmbralGlaive.js';
import { UnendingDespair } from './items/UnendingDespair.js';
import { VoidStaff } from './items/VoidStaff.js';
import { VoltaicCyclosword } from './items/VoltaicCyclosword.js';
import { WarmogsArmor } from './items/WarmogsArmor.js';
import { WintersApproach } from './items/WintersApproach.js';
import { WitsEnd } from './items/WitsEnd.js';
import { YoumuusGhostblade } from './items/YoumuusGhostblade.js';
import { YunTalWildarrows } from './items/YunTalWildarrows.js';
import { ZekesConvergence } from './items/ZekesConvergence.js';
import { ZhonyasHourglass } from './items/ZhonyasHourglass.js';

const championClasses = [Karthus, Twitch];
const itemClasses = [
  AbyssalMask,
  ArchangelsStaff,
  ArdentCenser,
  ArmoredAdvance,
  AxiomArc,
  BansheesVeil,
  BerserkersGreaves,
  BlackCleaver,
  BlackfireTorch,
  BladeOfTheRuinedKing,
  BloodlettersCurse,
  Bloodthirster,
  Boots,
  BootsOfSwiftness,
  ChainlacedCrushers,
  ChempunkChainsword,
  CosmicDrive,
  CrimsonLucidity,
  Cryptbloom,
  Dawncore,
  DeadMansPlate,
  DeathsDance,
  EchoesOfHelia,
  Eclipse,
  EdgeOfNight,
  EssenceReaver,
  ExperimentalHexplate,
  Fimbulwinter,
  ForceOfNature,
  ForeverForward,
  FrozenHeart,
  GuardianAngel,
  GuinsoosRageblade,
  GunmetalGreaves,
  Heartsteel,
  HextechRocketbelt,
  HollowRadiance,
  HorizonFocus,
  Hubris,
  Hullbreaker,
  IcebornGauntlet,
  ImmortalShieldbow,
  ImperialMandate,
  InfinityEdge,
  IonianBootsOfLucidity,
  JakShoTheProtean,
  KaenicRookern,
  KnightsVow,
  KrakenSlayer,
  LiandrysTorment,
  LichBane,
  LocketOfTheIronSolari,
  LordDominiksRegards,
  LudensCompanion,
  Malignance,
  Manamune,
  MawOfMalmortius,
  MejaisSoulstealer,
  MercurialScimitar,
  MercurysTreads,
  MikaelsBlessing,
  MoonstoneRenewer,
  Morellonomicon,
  MortalReminder,
  Muramana,
  NashorsTooth,
  NavoriFlickerblade,
  Opportunity,
  OverlordsBloodmail,
  PhantomDancer,
  PlatedSteelcaps,
  ProfaneHydra,
  RabadonsDeathcap,
  RanduinsOmen,
  RapidFirecannon,
  RavenousHydra,
  Redemption,
  Riftmaker,
  RodOfAges,
  RunaansHurricane,
  RylaisCrystalScepter,
  SeraphsEmbrace,
  SerpentsFang,
  SeryldasGrudge,
  Shadowflame,
  ShurelyasBattlesong,
  SorcerersShoes,
  SpearOfShojin,
  SpellslingersShoes,
  SpiritVisage,
  StaffOfFlowingWater,
  StatikkShiv,
  SteraksGage,
  Stormsurge,
  Stridebreaker,
  SunderedSky,
  SunfireAegis,
  Swiftmarch,
  SymbioticSoles,
  SynchronizedSouls,
  Terminus,
  TheCollector,
  Thornmail,
  TitanicHydra,
  Trailblazer,
  TrinityForce,
  UmbralGlaive,
  UnendingDespair,
  VoidStaff,
  VoltaicCyclosword,
  WarmogsArmor,
  WintersApproach,
  WitsEnd,
  YoumuusGhostblade,
  YunTalWildarrows,
  ZekesConvergence,
  ZhonyasHourglass
];
const championSelects = [
    document.getElementById('attacker-champion'),
    document.getElementById('defender-champion')
];
const levelInputs = [
    document.getElementById('attacker-level'),
    document.getElementById('defender-level')
];
const statsDivs = [
    document.getElementById('attacker-stats'),
    document.getElementById('defender-stats')
];

let champions = [null, null];
let items = [[], []];
let allItems = [];

function renderChampionOptions() {
    championSelects.forEach(select => {
        select.innerHTML = '';
        championClasses.forEach((champClass, idx) => {
            const champ = new champClass();
            const option = document.createElement('option');
            option.value = idx;
            option.textContent = champ.name;
            select.appendChild(option);
        });
    });
}

function updateChampion(side) {
    const champIdx = parseInt(championSelects[side].value);
    champions[side] = new championClasses[champIdx]();
    let currentLevel = parseInt(levelInputs[side].value);
    if (isNaN(currentLevel) || currentLevel < 1) currentLevel = 1;
    if (currentLevel > 18) currentLevel = 18;
    champions[side].level = currentLevel;
    if (typeof champions[side].recalculateStats === 'function') {
        champions[side].recalculateStats();
    }
    items[side] = Array(6).fill(null);
    updateChampionItems(side);
    renderStats(side);
    renderSkills(side);
}

function updateChampionItems(side) {
    if (!champions[side]) return;
    champions[side].inventory = Array(6).fill(null);
    items[side].forEach((idx, i) => {
        if (idx !== null && allItems[idx]) {
            champions[side].inventory[i] = allItems[idx]; // Aquí puedes adaptar si necesitas instanciar
        }
    });
    if (typeof champions[side].applyItemsStats === 'function') {
        champions[side].applyItemsStats();
    }
}

function renderStats(side) {
    if (!champions[side]) {
        statsDivs[side].innerHTML = '';
        return;
    }
    const champ = champions[side];
    const stats = [
        `HP: ${champ.actual_hp.toFixed(0)}`,
        `Mana: ${champ.actual_mana.toFixed(0)}`,
        `AD: ${champ.actual_ad.toFixed(1)}`,
        `AP: ${champ.actual_ap.toFixed(1)}`,
        `Armor: ${champ.actual_total_armor.toFixed(1)}`,
        `MR: ${champ.actual_total_mr.toFixed(1)}`,
        `Attack Speed: ${(champ.actual_attack_speed).toFixed(3)}`,
        `Move Speed: ${champ.actual_move_speed.toFixed(1)}`
    ];
    statsDivs[side].innerHTML = stats.map(s => `<div>${s}</div>`).join('');
}

championSelects.forEach((select, side) => {
    select.addEventListener('change', () => {
        updateChampion(side);
    });
});
levelInputs.forEach((input, side) => {
    input.addEventListener('input', () => {
        if (!champions[side]) return;
        let newLevel = parseInt(input.value);
        if (isNaN(newLevel) || newLevel < 1) newLevel = 1;
        if (newLevel > 18) newLevel = 18;
        champions[side].level = newLevel;
        if (typeof champions[side].recalculateStats === 'function') {
            champions[side].recalculateStats();
        }
        updateChampionItems(side);
        renderStats(side);
        renderSkills(side);
    });
});

function renderItemsByCategory(category) {
    const itemsListDiv = document.getElementById('items-icons-list');
    itemsListDiv.innerHTML = '';
    let filteredItems;
    if (category === 'all') {
        filteredItems = allItems;
    } else {
        filteredItems = allItems.filter(item => item.tags && item.tags.includes(category));
    }
    filteredItems.forEach(item => {
        const img = document.createElement('img');
        img.src = item.image;
        img.alt = item.name;
        img.className = 'item-icon';
        img.setAttribute('draggable', 'true');
        img.setAttribute('data-item', item.name.replace(/\s/g, ''));
        itemsListDiv.appendChild(img);
    });
    setupDragAndDrop();
}

// Drag & Drop de ítems
function setupDragAndDrop() {
    const itemIcons = document.querySelectorAll('.item-icon');
    const slotContainers = [
        document.getElementById('attacker-item-slots'),
        document.getElementById('defender-item-slots')
    ];

    itemIcons.forEach(icon => {
        icon.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', icon.getAttribute('data-item'));
        });
    });

    slotContainers.forEach((container, side) => {
        const slots = container.querySelectorAll('.item-slot');
        slots.forEach((slot, idx) => {
            slot.addEventListener('dragover', (e) => {
                e.preventDefault();
                slot.style.boxShadow = '0 0 8px #4e4ecf';
            });
            slot.addEventListener('dragleave', (e) => {
                slot.style.boxShadow = '';
            });
            slot.addEventListener('drop', (e) => {
                e.preventDefault();
                slot.style.boxShadow = '';
                const itemName = e.dataTransfer.getData('text/plain');
                const itemIdx = allItems.findIndex(item => item.name.replace(/\s/g, '') === itemName);
                if (itemIdx !== -1 && !items[side].includes(itemIdx)) {
                    items[side][idx] = itemIdx;
                    slot.innerHTML = `<img src="${allItems[itemIdx].image}" alt="${allItems[itemIdx].name}" class="item-icon" style="width:40px;height:40px;">`;
                    updateChampionItems(side);
                    renderStats(side);
                }
            });
            slot.addEventListener('dblclick', () => {
                items[side][idx] = null;
                slot.innerHTML = '';
                updateChampionItems(side);
                if (champions[side] && typeof champions[side].forceRecalcWithItems === 'function') {
                    champions[side].forceRecalcWithItems();
                }
                renderStats(side);
            });
        });
    });
}

document.getElementById('toggle-items').addEventListener('click', () => {
    const iconsBlock = document.getElementById('items-icons');
    iconsBlock.style.display = iconsBlock.style.display === 'none' ? 'block' : 'none';
});

window.addEventListener('DOMContentLoaded', () => {
    renderChampionOptions();
    updateChampion(0);
    updateChampion(1);
    renderSkills(0);
    renderSkills(1);
    // Instanciar todos los ítems manualmente y guardarlos en allItems
    allItems = itemClasses.map(ItemClass => new ItemClass());
    renderItemsByCategory('all');
    setupCategoryMenu();
    setupDragAndDrop();
});

function setupCategoryMenu() {
    const menu = document.getElementById('items-category-menu');
    if (!menu) return;
    menu.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            menu.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderItemsByCategory(btn.getAttribute('data-category'));
        });
    });
    menu.querySelector('.category-btn[data-category="all"]').classList.add('active');
}

function renderSkills(side) {
    const skillsDiv = document.getElementById(side === 0 ? 'attacker-skills' : 'defender-skills');
    const descDiv = document.getElementById(side === 0 ? 'attacker-skill-desc' : 'defender-skill-desc');
    skillsDiv.innerHTML = '';
    descDiv.innerHTML = '';
    if (!champions[side]) return;
    const champ = champions[side];
    const skillKeys = [ 'P', 'Q', 'W', 'E', 'R' ];
    skillKeys.forEach(key => {
        // Normalizar nombre del campeón para la ruta
        const champFolder = champ.name.replace(/\s/g, '').replace(/'/g, '').replace(/[^a-zA-Z0-9]/g, '');
        const imgName = `${champFolder}_${key}_ability.png`;
        const imgPath = `assets/champions/${champFolder}/${imgName}`;
        const skillElem = document.createElement('span');
        skillElem.className = 'skill';
        skillElem.innerHTML = `<img src="${imgPath}" alt="${key}" style="width:40px;height:40px;vertical-align:middle;border-radius:8px;">`;
        // Click: mostrar/cerrar descripción
        skillElem.addEventListener('click', () => {
            if (descDiv.getAttribute('data-open') === key) {
                descDiv.innerHTML = '';
                descDiv.removeAttribute('data-open');
            } else {
                descDiv.innerHTML = `<div class='skill-desc-block'><strong>${champ.name} ${key}</strong><br>${getSkillDescription(champ, key)}</div>`;
                descDiv.setAttribute('data-open', key);
            }
        });
        // Doble click: agregar a secuencia de acciones
        skillElem.addEventListener('dblclick', () => {
            addActionToSequence(champ.name, key);
        });
        skillsDiv.appendChild(skillElem);
    });
}

function getSkillDescription(champ, key) {
    // Puedes personalizar esto por campeón y habilidad
    if (champ.name === 'Karthus') {
        switch (key) {
            case 'P': return `<span style='color:#b0eaff;'>Desafía la muerte y lanza habilidades durante 7 segundos tras morir. <br> No puede moverse ni usar básicos, pero es inmune a control de masas y daño.</span>`;
            case 'Q': return `<span style='color:#b0eaff;'>Inflige daño mágico en área.</span>`;
            case 'W': return `<span style='color:#b0eaff;'>Reduce la resistencia mágica de los enemigos.</span>`;
            case 'E': return `<span style='color:#b0eaff;'>Daño mágico por segundo en área.</span>`;
            case 'R': return `<span style='color:#b0eaff;'>Daño global a todos los enemigos.</span>`;
        }
    }
    if (champ.name === 'Twitch') {
        switch (key) {
            case 'P': return `<span style='color:#b0eaff;'>Aplica veneno a los enemigos.</span>`;
            case 'Q': return `<span style='color:#b0eaff;'>Camuflaje y velocidad de ataque.</span>`;
            case 'W': return `<span style='color:#b0eaff;'>Lanza una nube de veneno.</span>`;
            case 'E': return `<span style='color:#b0eaff;'>Daño adicional según acumulación de veneno.</span>`;
            case 'R': return `<span style='color:#b0eaff;'>Aumenta el alcance y daño de los ataques.</span>`;
        }
    }
    return '<span style="color:#b0eaff;">Descripción no disponible.</span>';
}
